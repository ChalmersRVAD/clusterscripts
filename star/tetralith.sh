#!/bin/bash
#SBATCH -J <JOBNAME>
#SBATCH -N 64 -n 2048
#SBATCH -A <ALLOCATION>
#SBATCH -t 20:00:00

NODEFILE=hostlist.$SLURM_JOB_ID
hostlist -e $SLURM_JOB_NODELIST > $NODEFILE

module load star-ccm+/2019.2-mixed-precision

export MYCASE=$(find *.sim)

export MYJAVA="<BATCHFILE>"

export LM_PROJECT="POD-KEY"
export LM_LICENSE_FILE=1999@flex.cd-adapco.com

# Set some MPI tuning parameters
# Note that these are tuned for 64 nodes and 2048 cores, and might not be optimal for other configurations
export I_MPI_ADJUST_BCAST='1:0-0;8:1-1;10:2-7;1:8-8;11:9-64;8:65-159;4:160-420;1:421-799;11:800-2114;10:2115-9487;9:9488-101262;11:101263-550677;9:550678-1743856;11:1743857-4038303;10:4038304-2147483647'
export I_MPI_ADJUST_BARRIER='8'
export I_MPI_ADJUST_GATHER='3:0-0;4:1-3;1:4-8;4:9-16;1:17-634;2:635-9044;4:9045-16384;1:16385-64827;3:64828-2147483647'
export I_MPI_ADJUST_GATHERV='3:0-2147483647'
export I_MPI_ADJUST_ALLGATHER='3:0-0;5:1-1;2:2-3;5:4-6;2:7-8;1:9-28;4:29-6864;3:6865-2147483647'
export I_MPI_ADJUST_ALLGATHERV='4:0-0;1:1-2;2:3-6;1:7-8;2:9-24;4:25-3441;3:3442-2147483647'
export I_MPI_ADJUST_SCATTER='3:0-0;1:1-19368;3:19369-2147483647'
export I_MPI_ADJUST_SCATTERV='1:0-2147483647'
export I_MPI_ADJUST_REDUCE='1:0-0;8:1-7;9:8-20;7:21-48;10:49-94;6:95-180;11:181-438;4:439-1178;11:1179-3211;6:3212-6471;11:6472-12818;7:12819-30544;2:30545-37192;5:37193-1048576;3:1048577-2147483647'
export I_MPI_ADJUST_ALLREDUCE='6:0-0;11:1-5;10:6-11;11:12-43;10:44-109;11:110-314;12:315-890;6:891-1304;12:1305-2231;11:2232-6830;12:6831-16027;2:16028-2147483647'
export I_MPI_ADJUST_REDUCE_SCATTER='1:0-7;4:8-27;1:28-12219;3:12220-2147483647'
export I_MPI_ADJUST_ALLTOALL='1:0-95;4:96-407;1:408-649;3:650-1024;4:1025-2048;3:2049-54604;2:54605-2147483647'
export I_MPI_ADJUST_ALLTOALLV=2
export I_MPI_EAGER_THRESHOLD=3000
export I_MPI_SHM_CELL_SIZE=17000

starccm+ -collab -power -mpi intel -mpiflags "-bootstrap slurm -ofi" -rsh jobsh -batch $MYJAVA -np $SLURM_NTASKS -machinefile $NODEFILE $MYCASE > $(basename $MYCASE .sim).log 

rm $NODEFILE
